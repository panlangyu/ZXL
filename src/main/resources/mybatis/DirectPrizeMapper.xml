<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pro.bechat.wallet.domain.dao.DirectPrizeMapper">

    <!-- 封装用户推荐人信息记录 -->
    <resultMap id="BaseResultMap" type="pro.bechat.wallet.domain.model.vo.DirectPrizeVo">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="referee_id" jdbcType="INTEGER" property="refereeId"/>
        <result column="coverReferee_id" jdbcType="INTEGER" property="coverRefereeId"/>
        <result column="coinId" jdbcType="INTEGER" property="coinId"/>
        <result column="amountUsed" jdbcType="DECIMAL" property="amountUsed"/>
        <result column="amount" jdbcType="DECIMAL" property="amount"/>
        <result column="amountAvailable" jdbcType="DECIMAL" property="amountAvailable"/>
    </resultMap>

    <!-- 查询是否用户直推信息记录是否为3 -->
    <select id="selectDirectPrizeCount" parameterType="Integer" resultType="Integer">

        SELECT  COUNT(*)  FROM vah_d_directtprize

        <trim prefix="WHERE" prefixOverrides="AND | OR">

            <if test="refereeId != null and refereeId != 0">
                AND referee_id = #{refereeId}
            </if>

        </trim>

    </select>

    <!-- 查询是否用户直推的信息是否记录为3 -->
    <select id="selectDirectPrizeList" resultMap="BaseResultMap">

        SELECT  id,referee_id,coverReferee_id,coinId,
        amountUsed,amount,amountAvailable  FROM vah_d_directtprize

        WHERE amountUsed != amount

    </select>


    <!-- 新增直推奖记录 -->
    <insert id="insertDirectPrizeInfo" parameterType="pro.bechat.wallet.domain.model.model.DirectPrize" useGeneratedKeys="true"
            keyProperty="id">

      INSERT INTO vah_d_directtprize(
                    referee_id,
                    coverReferee_id,
                    coinId,
                    amountUsed,
                    amount,
                    amountAvailable,
                    create_time,
                    update_time
                  )
           VALUES(
                #{refereeId},
                #{coverRefereeId},
                #{coinId},
                DEFAULT,
                #{amount},
                #{amountAvailable},
                NOW(),
                NOW()
            )

    </insert>


    <!-- 修改直推奖返还数据 -->
    <update id="modifyDirectPrizeInfo" parameterType="pro.bechat.wallet.domain.model.model.DirectPrize">

        UPDATE vah_d_directtprize

        <trim prefix="SET" suffixOverrides="," suffix="WHERE id=#{id}">

            <if test="amount != null and amount != 0">
                amountUsed = amountUsed + #{amount},
                amountAvailable = amountAvailable - #{amount},
            </if>
            update_time = NOW(),
        </trim>



    </update>




</mapper>